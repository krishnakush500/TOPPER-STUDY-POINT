<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Results - Topper Study Point</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- html2pdf library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background:#f5f5f5; min-height:100vh; padding:20px; }
    .container { width:100%; max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95); border-radius:15px; box-shadow:0 15px 30px rgba(0,0,0,0.2); overflow:hidden; }

    /* Header */
    .header { background:linear-gradient(to right,#1a237e,#283593,#303f9f); color:white; padding:25px; text-align:center; position:relative; overflow:hidden; }
    .school-name { font-size:2rem; font-weight:700; line-height:1.2; }
    .location { font-size:1rem; margin-bottom:15px; }
    .director-info { display:flex; align-items:center; justify-content:center; margin-top:20px; flex-wrap:wrap; }
    .director-photo { width:100px; height:100px; border-radius:50%; border:4px solid white; overflow:hidden; margin-right:15px; }
    .director-photo img{width:100%;height:100%;object-fit:cover;}
    .director-details{text-align:left;}
    .director-details h2{font-size:1rem; margin-bottom:5px;}
    .director-details h3{font-size:1.1rem; margin-bottom:5px;}
    .director-details p{font-size:0.9rem;}

    /* Moving Notice Text */
    .marquee-container {
      background:#ffc107;
      overflow:hidden;
      position:relative;
      height:50px;
      display:flex;
      align-items:center;
    }
    .marquee-content {
      display:flex;
      animation: marquee 20s linear infinite;
      white-space:nowrap;
      font-weight:600;
      font-size:1.1rem;
      color:#333;
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    
    /* About Coaching Section */
    .about-coaching {
      padding: 25px;
      background: #fff;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .about-title {
      font-size: 1.8rem;
      color: #1a237e;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ffc107;
    }
    
    .about-content {
      font-size: 1rem;
      line-height: 1.8;
      color: #333;
      text-align: justify;
    }
    
    .highlight-box {
      background: linear-gradient(to right, #e8f4f8, #f0f8ff);
      border-left: 4px solid #1a237e;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    
    .highlight-box h4 {
      color: #1a237e;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .feature-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border-top: 3px solid #1a237e;
    }
    
    .feature-item i {
      color: #1a237e;
      font-size: 1.5rem;
      margin-bottom: 10px;
      display: block;
    }
    
    .feature-item h4 {
      color: #1a237e;
      margin-bottom: 8px;
    }

    /* Firebase Results Section */
    .results-section { padding:20px; background:#f9f9f9; }
    .section-title { font-size:1.5rem; color:#1a237e; text-align:center; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #1a237e; }
    
    .results-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:15px; margin-bottom:25px; }
    .result-item { background:white; padding:15px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); cursor:pointer; transition:all 0.3s; border-left:4px solid #1a237e; position:relative; }
    .result-item:hover { transform:translateY(-5px); box-shadow:0 8px 20px rgba(0,0,0,0.15); }
    .result-item.active { border-left-color:#ffc107; background:#fffae6; }
    .exam-name { font-size:1rem; color:#1a237e; font-weight:600; margin-bottom:8px; }
    .exam-date { font-size:0.8rem; color:#666; margin-bottom:5px; }
    
    /* NEW Sticker */
    .new-sticker {
      position:absolute;
      top:-8px;
      right:-8px;
      background:#ff4757;
      color:white;
      font-size:0.7rem;
      font-weight:bold;
      padding:4px 8px;
      border-radius:10px;
      animation: blink 1s infinite;
      z-index:10;
    }
    @keyframes blink {
      0%, 100% { opacity:1; }
      50% { opacity:0.7; }
    }
    
    .roll-input-section { background:white; padding:20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-top:20px; text-align:center; display:none; }
    .roll-input-section h3 { color:#1a237e; margin-bottom:15px; font-size:1.1rem; }
    .input-group { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }
    .input-group input { padding:10px 12px; font-size:0.95rem; border-radius:5px; border:1px solid #ccc; width:100%; max-width:250px; }
    .result-btn { padding:10px 20px; background:#1a237e; color:white; font-size:0.95rem; border:none; border-radius:8px; cursor:pointer; transition:background 0.3s; }
    .result-btn:hover { background:#283593; }
    
    /* Result Card - Mobile Optimized */
    .result-card { display:none; width:95%; max-width:700px; margin:20px auto; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:20px; position:relative; overflow-x:auto; }
    .result-card-header { text-align:center; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #1a237e; }
    .result-card-header h2 { color:#1a237e; margin-bottom:5px; font-size:1.3rem; }
    .result-card-header h3 { color:#b21f1f; margin-bottom:5px; font-size:1.1rem; }
    .result-card-header p { color:#666; font-size:0.85rem; }
    
    .student-info { margin-bottom:20px; }
    .info-row { display:flex; flex-direction:column; margin-bottom:8px; padding:8px 12px; background:#f5f5f5; border-radius:5px; }
    .info-label { font-weight:600; color:#1a237e; font-size:0.9rem; margin-bottom:3px; }
    .info-value { color:#333; font-size:0.95rem; }
    
    .marks-table { width:100%; border-collapse:collapse; margin-bottom:20px; min-width:500px; }
    .marks-table th { background:#1a237e; color:white; padding:10px; text-align:left; font-size:0.9rem; }
    .marks-table td { padding:10px; border-bottom:1px solid #ddd; font-size:0.9rem; }
    .marks-table tr:nth-child(even) { background:#f9f9f9; }
    .marks-table tr:hover { background:#f0f0f0; }
    
    .total-marks { background:#e8f5e8 !important; font-weight:600; color:#1a237e; }
    .percentage-display { text-align:center; font-size:1.2rem; color:#1a237e; font-weight:700; padding:12px; background:#f0f7ff; border-radius:10px; margin-top:15px; }
    .division-display { text-align:center; font-size:1.4rem; color:#1a237e; font-weight:700; padding:12px; margin-top:12px; border-radius:10px; }
    .coaching-mention { text-align:center; margin-top:15px; padding-top:12px; border-top:1px solid #ddd; color:#666; font-style:italic; font-size:0.9rem; }
    
    .action-buttons { display:flex; justify-content:center; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid #ddd; flex-wrap:wrap; }
    .action-buttons button { padding:10px 15px; font-size:0.9rem; border:none; border-radius:8px; cursor:pointer; transition:all 0.3s; display:flex; align-items:center; gap:5px; }
    .download-btn { background:#28a745; color:white; }
    .download-btn:hover { background:#218838; }
    .back-btn { background:#6c757d; color:white; }
    .back-btn:hover { background:#5a6268; }
    
    .loading { text-align:center; padding:20px; font-size:1rem; color:#1a237e; }
    .error { text-align:center; padding:15px; background:#ffe6e6; color:#b30000; border-radius:5px; margin:15px 0; }
    
    /* Footer */
    .footer { background:#1a237e; color:white; text-align:center; padding:15px; font-size:0.9rem; }
    
    /* Developer Contact Section */
    .developer-contact {
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
      border-top: 2px solid #1a237e;
      margin-top: 20px;
      border-radius: 0 0 15px 15px;
    }
    .developer-contact h3 {
      color: #1a237e;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .developer-contact p {
      color: #333;
      margin-bottom: 10px;
      font-size: 0.95rem;
    }
    .contact-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .contact-item {
      background: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.3s;
    }
    .contact-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .contact-item i {
      color: #1a237e;
      font-size: 1.1rem;
    }
    
    /* PDF Generation Fix Styles */
    .pdf-clone-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 10000;
      overflow: auto;
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }
    
    .pdf-clone {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    /* Media Queries for Mobile */
    @media (max-width: 768px) {
      .school-name { font-size:1.6rem; }
      .header { padding:15px; }
      .director-info { flex-direction:column; text-align:center; }
      .director-photo { margin-right:0; margin-bottom:10px; }
      .director-details { text-align:center; }
      
      .results-list { grid-template-columns:1fr; }
      
      .marks-table { font-size:0.85rem; min-width:450px; }
      .marks-table th, .marks-table td { padding:8px; }
      
      .action-buttons { flex-direction:column; }
      .action-buttons button { width:100%; justify-content:center; }
      
      .about-title { font-size: 1.5rem; }
      .about-content { font-size: 0.95rem; }
      .features { grid-template-columns: 1fr; }
      
      /* Developer contact mobile */
      .contact-info {
        flex-direction: column;
        gap: 10px;
      }
      .contact-item {
        padding: 10px 15px;
      }
      
      /* Adjust PDF clone for mobile */
      .pdf-clone {
        padding: 15px;
        margin: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .school-name { font-size:1.4rem; }
      .section-title { font-size:1.3rem; }
      .result-card { padding:15px; }
      .marks-table { min-width:350px; }
      .marks-table th, .marks-table td { padding:6px; font-size:0.8rem; }
      .about-title { font-size: 1.3rem; }
      .about-content { font-size: 0.9rem; }
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="school-name">Topper Study Point</h1>
      <p class="location">Patori, Samastipur</p>
      <div class="director-info">
        <div class="director-photo"><img src="https://i.ibb.co/4ggdyKnK/logo.jpg"></div>
        <div class="director-details">
          <h2>DIRECTOR</h2>
          <h3>NITISH SIR</h3>
          <p><i class="fas fa-phone"></i> Call: +91 9525826010</p>
        </div>
      </div>
    </div>

    <!-- Moving Notice Text -->
    <div class="marquee-container">
      <div class="marquee-content" id="marquee-content">
        <!-- Notice content will be loaded from Firebase -->
      </div>
    </div>

    <!-- Firebase Results Section -->
    <div class="results-section">
      <h2 class="section-title">ðŸ“Š Check Your Results</h2>
      
      <div class="loading" id="loading-results">
        <i class="fas fa-spinner fa-spin"></i> Loading available results...
      </div>
      
      <div class="results-list" id="results-list" style="display:none;"></div>
      
      <div class="roll-input-section" id="roll-input-section">
        <h3 id="selected-exam-name">Enter your Roll Number</h3>
        <div class="input-group">
          <input type="number" id="roll-input" placeholder="Enter Roll Number">
          <button class="result-btn" onclick="fetchStudentResult()">ðŸ“‘ Get Result</button>
          <button class="result-btn" onclick="goBackToResults()" style="background:#666;">â¬… Back</button>
        </div>
      </div>
      
      <div class="result-card" id="result-card">
        <div class="result-card-header">
          <h2>Topper Study Point, Patori Samastipur</h2>
          <h3 id="result-exam-name">Exam Name</h3>
          <p>Under the guidance of <strong>NITISH SIR</strong></p>
        </div>
        
        <div class="student-info">
          <div class="info-row">
            <span class="info-label">Student Name:</span>
            <span class="info-value" id="result-student-name">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Father's Name:</span>
            <span class="info-value" id="result-father-name">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Roll Number:</span>
            <span class="info-value" id="result-roll-no">-</span>
          </div>
        </div>
        
        <table class="marks-table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Marks Obtained</th>
              <th>Total Marks</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody id="marks-table-body">
            <!-- Marks will be populated here -->
          </tbody>
        </table>
        
        <div class="percentage-display" id="total-percentage">
          Total Percentage: 0%
        </div>
        
        <div class="division-display" id="division-display">
          Division: -
        </div>
        
        <div class="coaching-mention">
          <p>This result is published by Topper Study Point, Patori Samastipur | Director: NITISH SIR</p>
          <p>For any queries, contact: +91 9525826010</p>
        </div>
        
        <div class="action-buttons">
          <button class="download-btn" onclick="downloadResultAsPDF()">
            <i class="fas fa-download"></i> Download Result PDF
          </button>
          <button class="back-btn" onclick="goBackToResults()">
            <i class="fas fa-arrow-left"></i> Back to Results
          </button>
        </div>
      </div>
    </div>

    <!-- About Coaching Section -->
    <div class="about-coaching">
      <h2 class="about-title">About Topper Study Point</h2>
      
      <div class="about-content">
        <p>Welcome to <strong>Topper Study Point</strong>, Patori, Samastipur's premier coaching institute dedicated to academic excellence and holistic development of students. Established with a vision to create future leaders, we provide quality education for students from 6th to 12th grade.</p>
        
        <div class="highlight-box">
          <h4>ðŸŽ¯ Our Mission</h4>
          <p>To provide comprehensive, quality education that empowers students to achieve academic excellence, develop critical thinking skills, and become responsible citizens.</p>
        </div>
        
        <p>At Topper Study Point, we believe that every student has the potential to excel. Our experienced faculty, innovative teaching methods, and personalized attention ensure that each student receives the guidance they need to succeed in both board exams and competitive entrance tests.</p>
        
        <div class="features">
          <div class="feature-item">
            <i class="fas fa-graduation-cap"></i>
            <h4>Expert Faculty</h4>
            <p>Highly qualified and experienced teachers dedicated to student success</p>
          </div>
          
          <div class="feature-item">
            <i class="fas fa-book"></i>
            <h4>Comprehensive Study Material</h4>
            <p>Well-researched study materials covering all topics in detail</p>
          </div>
          
          <div class="feature-item">
            <i class="fas fa-chart-line"></i>
            <h4>Regular Tests & Analysis</h4>
            <p>Weekly tests with detailed performance analysis and feedback</p>
          </div>
          
          <div class="feature-item">
            <i class="fas fa-users"></i>
            <h4>Personalized Attention</h4>
            <p>Small batch sizes ensuring individual attention to every student</p>
          </div>
        </div>
        
        <div class="highlight-box">
          <h4>ðŸ“ž Join Us Today!</h4>
          <p>Admissions are open for all classes (6th to 12th). Limited seats available. For admission and inquiries, contact:</p>
          <p style="margin-top: 10px;"><strong>Nitish Sir: +91 9525826010</strong></p>
          <p><strong>Address: Patori, Samastipur (In front of S.S. Girls High School)</strong></p>
        </div>
      </div>
    </div>

    <!-- Developer Contact Section -->
    <div class="developer-contact">
      <h3><i class="fas fa-laptop-code"></i> Website Development Contact</h3>
      <p>This website was developed by:</p>
      <div class="contact-info">
        <div class="contact-item">
          <i class="fas fa-phone"></i>
          <span>Phone: 8580594404</span>
        </div>
        <div class="contact-item">
          <i class="fas fa-envelope"></i>
          <span>Email: kk5674010@gmail.com</span>
        </div>
      </div>
      <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
        If you want a similar website for your coaching centre or business, feel free to contact me.
      </p>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>&copy; 2025 Topper Study Point. All Rights Reserved.</p>
    </div>
  </div>

  <!-- PDF Clone Container (Hidden) -->
  <div id="pdf-clone-container" class="pdf-clone-container"></div>

  <!-- Firebase Configuration and JavaScript -->
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC0CfwRBrVCa7k_eE8bTw8oJB2DYFvBjBw",
      authDomain: "srishti-b56d3.firebaseapp.com",
      projectId: "srishti-b56d3",
      storageBucket: "srishti-b56d3.firebasestorage.app",
      messagingSenderId: "150958353608",
      appId: "1:150958353608:web:3c0d4a2f2ab0070cd709fd"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allResults = [];
    let selectedExamId = null;
    let selectedExamData = null;
    let currentStudentResult = null;
    let newResults = []; // Track which results are "new"
    let viewedResults = []; // Track which results have been viewed
    let currentNotice = ""; // Store current notice

    // Load viewed results from localStorage
    function loadViewedResults() {
      const stored = localStorage.getItem('topper_viewed_results');
      viewedResults = stored ? JSON.parse(stored) : [];
    }

    // Save viewed results to localStorage
    function saveViewedResults() {
      localStorage.setItem('topper_viewed_results', JSON.stringify(viewedResults));
    }

    // Mark a result as viewed
    function markResultAsViewed(resultId) {
      if (!viewedResults.includes(resultId)) {
        viewedResults.push(resultId);
        saveViewedResults();
      }
    }

    // Check if a result is "new" (not viewed yet)
    function isResultNew(resultId) {
      return !viewedResults.includes(resultId);
    }

    // Fetch notice from Firestore
    async function fetchNotice() {
      try {
        const querySnapshot = await db.collection("notices").orderBy("createdAt", "desc").limit(1).get();
        
        if (!querySnapshot.empty) {
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            currentNotice = data.content || "All class has started enroll now";
            
            // Update marquee display
            updateMarqueeDisplay();
          });
        } else {
          // Default notice if none exists
          currentNotice = "All class has started enroll now";
          updateMarqueeDisplay();
        }
      } catch (error) {
        console.error("Error fetching notice:", error);
        currentNotice = "All class has started enroll now";
        updateMarqueeDisplay();
      }
    }

    // Update marquee display
    function updateMarqueeDisplay() {
      // Update marquee
      const marqueeContent = document.getElementById('marquee-content');
      let marqueeHtml = '';
      for (let i = 0; i < 5; i++) {
        marqueeHtml += `<span>ðŸ“¢ ${currentNotice} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>`;
      }
      marqueeContent.innerHTML = marqueeHtml;
    }

    // Fetch all results from Firestore
    async function fetchAllResults() {
      try {
        loadViewedResults(); // Load previously viewed results
        
        const querySnapshot = await db.collection("results").get();
        allResults = [];
        newResults = []; // Reset new results array
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const resultId = doc.id;
          const isNew = isResultNew(resultId);
          
          if (isNew) {
            newResults.push(resultId);
          }
          
          allResults.push({
            id: resultId,
            examName: data.examName || "Unnamed Exam",
            createdAt: data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString('en-IN', {
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            }) : "Date not available",
            data: data,
            isNew: isNew
          });
        });
        
        // Sort by date (newest first)
        allResults.sort((a, b) => {
          return b.data.createdAt?.toDate() - a.data.createdAt?.toDate();
        });
        
        displayResultsList();
      } catch (error) {
        console.error("Error fetching results:", error);
        document.getElementById("loading-results").innerHTML = 
          '<div class="error">Error loading results. Please try again later.</div>';
      }
    }

    // Display results list
    function displayResultsList() {
      const resultsList = document.getElementById("results-list");
      const loading = document.getElementById("loading-results");
      
      if (allResults.length === 0) {
        loading.innerHTML = '<div class="error">No results available at the moment.</div>';
        return;
      }
      
      loading.style.display = "none";
      resultsList.style.display = "grid";
      
      let html = "";
      allResults.forEach((result, index) => {
        const newSticker = result.isNew ? '<div class="new-sticker">NEW</div>' : '';
        html += `
          <div class="result-item" onclick="selectExam('${result.id}', ${index})" id="result-item-${index}">
            ${newSticker}
            <div class="exam-name">${result.examName}</div>
            <div class="exam-date">ðŸ“… Published: ${result.createdAt}</div>
          </div>
        `;
      });
      
      resultsList.innerHTML = html;
    }

    // Select an exam
    function selectExam(examId, index) {
      selectedExamId = examId;
      selectedExamData = allResults[index].data;
      
      // Mark this result as viewed (remove NEW sticker)
      markResultAsViewed(examId);
      
      // Update the result item to remove NEW sticker
      const resultItem = document.getElementById(`result-item-${index}`);
      if (resultItem) {
        const newSticker = resultItem.querySelector('.new-sticker');
        if (newSticker) {
          newSticker.remove();
        }
      }
      
      // Highlight selected item
      document.querySelectorAll('.result-item').forEach(item => {
        item.classList.remove('active');
      });
      document.getElementById(`result-item-${index}`).classList.add('active');
      
      // Show roll number input section
      document.getElementById('selected-exam-name').textContent = 
        `Enter your Roll Number for: ${selectedExamData.examName}`;
      document.getElementById('results-list').style.display = 'none';
      document.getElementById('roll-input-section').style.display = 'block';
      document.getElementById('result-card').style.display = 'none';
      
      // Clear previous input
      document.getElementById('roll-input').value = '';
    }

    // Go back to results list
    function goBackToResults() {
      document.getElementById('results-list').style.display = 'grid';
      document.getElementById('roll-input-section').style.display = 'none';
      document.getElementById('result-card').style.display = 'none';
      selectedExamId = null;
      selectedExamData = null;
      currentStudentResult = null;
      
      // Remove active class
      document.querySelectorAll('.result-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    // Calculate division based on percentage
    function calculateDivision(percentage) {
      if (percentage >= 60) {
        return {
          division: "FIRST DIVISION",
          color: "#28a745",
          bgColor: "#d4edda"
        };
      } else if (percentage >= 45) {
        return {
          division: "SECOND DIVISION",
          color: "#17a2b8",
          bgColor: "#d1ecf1"
        };
      } else if (percentage >= 30) {
        return {
          division: "THIRD DIVISION",
          color: "#ffc107",
          bgColor: "#fff3cd"
        };
      } else {
        return {
          division: "FAIL",
          color: "#dc3545",
          bgColor: "#f8d7da"
        };
      }
    }

    // Fetch student result
    function fetchStudentResult() {
      const rollInput = document.getElementById('roll-input').value.trim();
      
      if (!rollInput) {
        alert("Please enter your roll number");
        return;
      }
      
      if (!selectedExamData || !selectedExamData.students) {
        alert("Exam data not loaded properly. Please go back and select again.");
        return;
      }
      
      // Find student by roll number
      const student = selectedExamData.students.find(s => s.rollNo == rollInput);
      
      if (!student) {
        alert("Roll number not found in this exam.");
        return;
      }
      
      // Display result
      displayStudentResult(student);
    }

    // Display student result
    function displayStudentResult(student) {
      currentStudentResult = student;
      
      // Hide input section, show result card
      document.getElementById('roll-input-section').style.display = 'none';
      const resultCard = document.getElementById('result-card');
      resultCard.style.display = 'block';
      
      // Set exam info
      document.getElementById('result-exam-name').textContent = selectedExamData.examName;
      
      // Set student info
      document.getElementById('result-student-name').textContent = student.name || "-";
      document.getElementById('result-father-name').textContent = student.fatherName || "-";
      document.getElementById('result-roll-no').textContent = student.rollNo || "-";
      
      // Calculate and display marks
      const marksTable = document.getElementById('marks-table-body');
      let html = '';
      let totalObtained = 0;
      let totalPossible = 0;
      
      if (student.marks && selectedExamData.subjects) {
        // Loop through subjects from exam data
        selectedExamData.subjects.forEach(subject => {
          const subjectName = subject.name;
          const subjectTotal = subject.total || 100;
          const marksObtained = student.marks[subjectName] || 0;
          const percentage = ((marksObtained / subjectTotal) * 100).toFixed(2);
          
          html += `
            <tr>
              <td>${subjectName}</td>
              <td>${marksObtained}</td>
              <td>${subjectTotal}</td>
              <td>${percentage}%</td>
            </tr>
          `;
          
          totalObtained += marksObtained;
          totalPossible += subjectTotal;
        });
        
        // Add total row
        const totalPercentage = totalPossible > 0 ? ((totalObtained / totalPossible) * 100).toFixed(2) : 0;
        html += `
          <tr class="total-marks">
            <td><strong>Total</strong></td>
            <td><strong>${totalObtained}</strong></td>
            <td><strong>${totalPossible}</strong></td>
            <td><strong>${totalPercentage}%</strong></td>
          </tr>
        `;
        
        document.getElementById('total-percentage').textContent = 
          `Total Percentage: ${totalPercentage}%`;
        
        // Calculate and display division
        const divisionInfo = calculateDivision(parseFloat(totalPercentage));
        const divisionElement = document.getElementById('division-display');
        divisionElement.textContent = `Division: ${divisionInfo.division}`;
        divisionElement.style.backgroundColor = divisionInfo.bgColor;
        divisionElement.style.color = divisionInfo.color;
        divisionElement.style.border = `2px solid ${divisionInfo.color}`;
        
      } else {
        html = '<tr><td colspan="4" style="text-align:center;">Marks data not available</td></tr>';
        document.getElementById('division-display').textContent = 'Division: N/A';
      }
      
      marksTable.innerHTML = html;
      
      // Scroll to result
      resultCard.scrollIntoView({ behavior: 'smooth' });
    }

    // Create clone for PDF generation
    function createPDFClone() {
      const resultCard = document.getElementById('result-card');
      const cloneContainer = document.getElementById('pdf-clone-container');
      
      // Clear previous clone
      cloneContainer.innerHTML = '';
      
      // Create a deep clone of the result card
      const clone = resultCard.cloneNode(true);
      clone.classList.add('pdf-clone');
      clone.style.display = 'block';
      clone.style.width = '100%';
      clone.style.maxWidth = '800px';
      clone.style.margin = '20px auto';
      clone.style.padding = '20px';
      clone.style.background = 'white';
      clone.style.boxShadow = '0 0 20px rgba(0,0,0,0.1)';
      clone.style.position = 'relative';
      clone.style.left = '0';
      clone.style.top = '0';
      clone.style.transform = 'none';
      clone.style.zIndex = '10001';
      
      // Remove action buttons from clone
      const actionButtons = clone.querySelector('.action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Show the clone container and add the clone
      cloneContainer.appendChild(clone);
      cloneContainer.style.visibility = 'visible';
      cloneContainer.style.opacity = '0';
      cloneContainer.style.pointerEvents = 'none';
      
      return clone;
    }

    // Preload all images in the result card
    function preloadImages(callback) {
      const images = document.querySelectorAll('#result-card img');
      let loadedCount = 0;
      const totalImages = images.length;
      
      if (totalImages === 0) {
        callback();
        return;
      }
      
      const onImageLoad = () => {
        loadedCount++;
        if (loadedCount === totalImages) {
          callback();
        }
      };
      
      images.forEach(img => {
        if (img.complete) {
          onImageLoad();
        } else {
          img.onload = onImageLoad;
          img.onerror = onImageLoad; // Also continue if image fails to load
        }
      });
    }

    // Download result as PDF - FIXED VERSION
    function downloadResultAsPDF() {
      // Disable the download button to prevent multiple clicks
      const downloadBtn = document.querySelector('.download-btn');
      const originalText = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
      downloadBtn.disabled = true;
      
      // Create a clone for PDF generation
      const clone = createPDFClone();
      const cloneContainer = document.getElementById('pdf-clone-container');
      
      // Show the clone container (but keep it invisible)
      cloneContainer.style.visibility = 'visible';
      cloneContainer.style.opacity = '0';
      
      // Wait a bit for DOM to settle
      setTimeout(() => {
        // Preload images before generating PDF
        preloadImages(() => {
          // Generate PDF with optimized settings
          const options = {
            margin: [10, 10, 10, 10],
            filename: `Result_${currentStudentResult?.rollNo || 'unknown'}.pdf`,
            image: { 
              type: 'jpeg', 
              quality: 0.98 
            },
            html2canvas: { 
              scale: 2,
              useCORS: true,
              letterRendering: true,
              scrollX: 0,
              scrollY: 0,
              windowWidth: clone.scrollWidth,
              windowHeight: clone.scrollHeight,
              backgroundColor: '#ffffff',
              logging: false,
              onclone: function(clonedDoc) {
                // Ensure all images in clone are visible
                const clonedImages = clonedDoc.querySelectorAll('img');
                clonedImages.forEach(img => {
                  img.style.display = 'block';
                  img.style.maxWidth = '100%';
                  img.style.height = 'auto';
                });
              }
            },
            jsPDF: { 
              unit: 'mm', 
              format: 'a4', 
              orientation: 'portrait',
              compress: true
            },
            pagebreak: { 
              mode: ['avoid-all', 'css', 'legacy'],
              before: '.page-break-before',
              after: '.page-break-after',
              avoid: ['.no-break', 'tr', 'td']
            }
          };
          
          // Generate and save PDF
          html2pdf().set(options).from(clone).save().then(() => {
            // Cleanup: hide the clone container
            cloneContainer.style.visibility = 'hidden';
            cloneContainer.innerHTML = '';
            
            // Re-enable the download button
            downloadBtn.innerHTML = originalText;
            downloadBtn.disabled = false;
            
            // Show success message
            alert('PDF downloaded successfully!');
          }).catch(error => {
            console.error('PDF generation error:', error);
            cloneContainer.style.visibility = 'hidden';
            cloneContainer.innerHTML = '';
            
            // Re-enable the download button
            downloadBtn.innerHTML = originalText;
            downloadBtn.disabled = false;
            
            // Fallback: try simple method
            alert('Generating PDF... Please wait.');
            try {
              const fallbackOptions = {
                margin: 10,
                filename: `Result_${currentStudentResult?.rollNo || 'unknown'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
              };
              
              html2pdf().set(fallbackOptions).from(resultCard).save().then(() => {
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
              });
            } catch (fallbackError) {
              alert('Error generating PDF. Please try again or take a screenshot.');
              downloadBtn.innerHTML = originalText;
              downloadBtn.disabled = false;
            }
          });
        });
      }, 500);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      fetchNotice(); // Fetch notice first
      fetchAllResults(); // Then fetch results
    });
  </script>
</body>
</html>
